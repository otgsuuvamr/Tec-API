<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Alterar Senha</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-blue-100 flex justify-center items-center min-h-screen">
    <nav
      class="fixed top-0 left-0 right-0 bg-white shadow-md p-4 flex justify-between items-center z-50"
    >
      <a href="../product.html"
        ><h1 class="text-xl font-bold text-blue-600">LojaTec</h1></a
      >
      <div class="flex items-center gap-4">
        <a
          href="profile.html"
          class="text-gray-700 hover:text-blue-600"
          title="Meu Perfil"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-7 h-7"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5.121 17.804A9 9 0 1118.879 6.196M15 11a3 3 0 11-6 0 3 3 0 016 0z"
            />
          </svg>
        </a>
        <button
          onclick="logout()"
          class="text-red-600 hover:text-red-800 font-semibold"
        >
          Sair
        </button>
        <script>
          function logout() {
            localStorage.removeItem("token");
            window.location.href = "index.html";
          }
        </script>
      </div>
    </nav>

    <div class="bg-white p-6 rounded shadow-md w-96 mt-28">
      <h1 class="text-xl font-bold mb-4 text-center">üîê Alterar Senha</h1>

      <input
        id="currentPass"
        type="password"
        placeholder="Senha atual"
        class="input mb-3"
      />
      <input
        id="newPass"
        type="password"
        placeholder="Nova senha"
        class="input mb-3"
      />
      <button
        onclick="requestPasswordChange()"
        class="btn bg-yellow-600 w-full"
      >
        Solicitar Altera√ß√£o
      </button>

      <div id="confirmSection" class="hidden mt-4">
        <input
          id="code"
          type="text"
          placeholder="Digite o c√≥digo recebido"
          class="input mb-3"
        />
        <button onclick="confirmChange()" class="btn bg-green-600 w-full">
          Confirmar Altera√ß√£o
        </button>
      </div>

      <p id="status" class="text-sm text-center mt-3 font-semibold"></p>
    </div>

    <style>
      .input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 0.375rem;
      }
      .btn {
        padding: 0.5rem;
        color: white;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
      }
    </style>

    <script>
      const API_REQUEST = "http://localhost:3000/auth/me/password/request";
      const API_CONFIRM = "http://localhost:3000/auth/me/confirm-change";
      const token = localStorage.getItem("token");

      async function requestPasswordChange() {
        const currentPass = document.getElementById("currentPass").value;
        const newPass = document.getElementById("newPass").value;

        const res = await fetch(API_REQUEST, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify({ currentPass, newPass }),
        });

        const data = await res.json();
        document.getElementById("status").textContent =
          data.message || data.error;

        if (res.ok) {
          document.getElementById("confirmSection").classList.remove("hidden");
        }
      }

      async function confirmChange() {
        const code = document.getElementById("code").value;
        const res = await fetch(API_CONFIRM, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify({ code }),
        });

        const data = await res.json();
        document.getElementById("status").textContent =
          data.message || data.error;

        if (res.ok) {
          document.getElementById("status").classList.add("text-green-600");
          setTimeout(() => (window.location.href = "profile.html"), 1500);
        } else {
          document.getElementById("status").classList.add("text-red-600");
        }
      }
    </script>
  </body>
</html>
