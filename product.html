<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Loja Tec</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-blue-100 text-gray-800 font-sans">
    <nav class="fixed top-0 left-0 right-0 bg-white shadow-md px-6 py-3 flex justify-between items-center z-50">
      <h1 class="text-xl font-bold text-blue-600">LojaTec</h1>
      <div class="flex items-center gap-6">
        <!-- √çcone de perfil -->
        <a href="public/profile.html" class="text-gray-700 hover:text-blue-600" title="Meu Perfil">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M5.121 17.804A9 9 0 1118.879 6.196M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </a>
        <!-- Bot√£o sair -->
        <button onclick="logout()" class="text-red-600 hover:text-red-800 font-semibold">
          Sair
        </button>
      </div>
    </nav>
    <script>
      function logout() {
        localStorage.removeItem("token");
        window.location.href = "index.html";
      }
    </script>
    
      </div>
    </nav>

    <!-- üîπ Ajuste de espa√ßamento para n√£o esconder o conte√∫do -->
    <div class="pt-20 max-w-4xl mx-auto p-5">
      <h1 class="text-3xl font-bold text-center mb-6">
        üì¶ Gerenciador de Produtos
      </h1>

      <div class="grid grid-cols-2 gap-4 mb-6">
        <input id="id" placeholder="ID" class="input" />
        <input id="titulo" placeholder="T√≠tulo" class="input" />
        <input id="preco" placeholder="Pre√ßo" class="input" />
        <input id="descricao" placeholder="Descri√ß√£o" class="input" />
        <label class="flex items-center gap-2">
          <input type="checkbox" id="emEstoque" checked />
          <span>Em Estoque?</span>
        </label>
      </div>

      <div class="flex gap-4 justify-center mb-6">
        <button onclick="AddProd()" class="btn bg-green-500">Adicionar</button>
        <button onclick="AttProd()" class="btn bg-yellow-500">Atualizar</button>
        <button onclick="DeleteProd()" class="btn bg-red-500">Excluir</button>
        <button onclick="ReadProd()" class="btn bg-blue-500">Buscar</button>
      </div>

      <div id="result" class="bg-white shadow p-4 rounded"></div>
    </div>

    <style>
      .input {
        padding: 0.5rem;
        border: 1px solid #8f8f8f;
        border-radius: 0.375rem;
        width: 100%;
      }

      .btn {
        padding: 0.5rem 1rem;
        color: white;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
      }
    </style>

    <script>
      const API = "http://localhost:3000/products/";
      const token = localStorage.getItem("token");

      if (!token) {
        alert("Voc√™ precisa estar logado para acessar esta √°rea.");
        window.location.href = "/public/index.html";
      }

      function renderResult(data) {
        const resultDiv = document.getElementById("result");
        let html = "";

        if (data.message) {
          html += `<p class="text-green-700 font-semibold mb-2">${data.message}</p>`;
        }

        // Produto √∫nico
        if (data.product) {
          html += formatProduct(data.product);
        }

        // Lista de produtos
        else if (data.products && Array.isArray(data.products)) {
          html += `<p>Total de produtos: ${data.totalProd}</p>`;
          data.products.forEach((p, index) => {
            html += `<div class="mt-2 border-t pt-2">${formatProduct(
              p,
              index + 1
            )}</div>`;
          });
        }

        // Mensagem de texto pura (ex: delete)
        else if (typeof data.message === "string") {
          html += `<p>${data.message}</p>`;
        }

        // Erro
        else if (data.error) {
          html += `<p class="text-red-600">‚ùå Erro: ${data.error}</p>`;
        }

        resultDiv.innerHTML = html;
      }

      function formatProduct(prod, index = null) {
        const emEstoque = prod.emEstoque ? "Sim" : "N√£o";
        return `
              <div class="bg-gray-50 p-3 rounded shadow-sm mb-2">
            ${
              index
                ? `<h3 class="font-bold text-lg mb-1">Produto ${index}</h3>`
                : ""
            }
            <p><strong>ID:</strong> ${prod._id}</p>
            <p><strong>T√≠tulo:</strong> ${prod.titulo}</p>
            <p><strong>Pre√ßo:</strong> R$ ${prod.preco.toFixed(2)}</p>
            <p><strong>Descri√ß√£o:</strong> ${prod.descricao}</p>
            <p><strong>Em Estoque:</strong> ${emEstoque}</p>
          </div>
        `;
      }

      function AddProd() {
        const titulo = document.getElementById("titulo").value;
        const preco = parseFloat(document.getElementById("preco").value);
        const descricao = document.getElementById("descricao").value;
        const emEstoque = document.getElementById("emEstoque").checked;

        fetch(API, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify({ titulo, preco, descricao, emEstoque }),
        })
          .then((res) => res.json())
          .then(renderResult)
          .catch((error) => {
            error.json().then((error) => {
              renderError("Erro: " + (error.error || "Erro desconhecido."));
            });
          });
      }

      function AttProd() {
        const id = document.getElementById("id").value;
        const titulo = document.getElementById("titulo").value;
        const precoRaw = document.getElementById("preco").value.trim();
        const descricao = document.getElementById("descricao").value;
        const emEstoque = document.getElementById("emEstoque").checked;

        const payload = {};
        if (titulo) payload.titulo = titulo;
        if (precoRaw) {
          const preco = parseFloat(precoRaw);
          if (!isNaN(preco)) payload.preco = preco;
        }
        if (descricao) payload.descricao = descricao;
        payload.emEstoque = emEstoque;

        fetch(API + id, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify(payload),
        })
          .then((res) => res.json())
          .then(renderResult)
          .catch(async (error) => {
            error.json().then((error) => {
              renderError("Erro: " + (error.error || "Erro desconhecido."));
            });
          });
      }

      function DeleteProd() {
        const id = document.getElementById("id").value;
        fetch(API + id, {
          method: "DELETE",
          headers: {
            Authorization: "Bearer " + token,
          },
        })
          .then((res) => res.text())
          .then((text) => renderResult({ message: text }))
          .catch((error) => {
            error.json().then((error) => {
              renderError("Erro: " + (error.error || "Erro desconhecido."));
            });
          });
      }

      function ReadProd() {
        const id = document.getElementById("id").value;
        const url = id ? API + id : API;

        fetch(url, {
          headers: {
            Authorization: "Bearer " + token,
          },
        })
          .then((res) => res.json())
          .then(renderResult)
          .catch((error) => {
            error.json().then((error) => {
              renderError("Erro: " + (error.error || "Erro desconhecido."));
            });
          });
      }
    </script>
  </body>
</html>
